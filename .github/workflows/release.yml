name: Release Desktop App

on:
  push:
    tags:
      - "v*" # Trigger on version tags like v0.3.0

env:
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]
        # Future: Add macos-latest and ubuntu-20.04 when ready

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies
        run: npm ci

      # Windows-specific setup for code signing (when certificate is available)
      # - name: Decode certificate (Windows)
      #   if: matrix.platform == 'windows-latest' && env.WINDOWS_CERTIFICATE != ''
      #   env:
      #     WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
      #   run: |
      #     echo $env:WINDOWS_CERTIFICATE | Out-File -FilePath cert.txt
      #     certutil -decode cert.txt certificate.pfx

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          # Uncomment when Windows certificate is available:
          # WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          # WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Ten10 ${{ github.ref_name }}"
          releaseBody: |
            ## What's New in ${{ github.ref_name }}

            ### Installation
            Download the appropriate installer for your platform:
            - **Windows**: Use the `.msi` or `.exe` installer

            ### Auto-Updates
            This version supports automatic updates. The app will check for new versions on startup.

            ### Changelog
            See the [full changelog](https://github.com/yossi-weinberger/ten10/blob/main/CHANGELOG.md) for details.

            ---
            **Note**: This is an automatic release generated by GitHub Actions.
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: true
          updaterJsonPreferNsis: true

      - name: Build offline installer (with WebView2)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          node -e "
          const fs = require('fs');
          const path = 'src-tauri/tauri.conf.json';
          const j = JSON.parse(fs.readFileSync(path, 'utf8'));
          j.bundle.windows = j.bundle.windows || {};
          j.bundle.windows.webviewInstallMode = { type: 'offlineInstaller' };
          fs.writeFileSync(path, JSON.stringify(j, null, 2));
          "
          # Clean previous builds to ensure we pick the right file
          Remove-Item -Path "src-tauri/target/release/bundle/nsis/*.exe" -ErrorAction SilentlyContinue
          npx tauri build
          $nsisDir = "src-tauri/target/release/bundle/nsis"
          $exeName = (Get-ChildItem $nsisDir -Filter "*.exe" | Where-Object { $_.Name -notmatch "\.sig$" } | Select-Object -First 1).Name
          $version = (Get-Content package.json | ConvertFrom-Json).version
          $sourcePath = Join-Path $nsisDir $exeName
          Copy-Item $sourcePath "Ten10_${version}_x64_with_WebView2-setup.exe"
          git checkout -- src-tauri/tauri.conf.json

      - name: Upload offline installer to release
        run: |
          $exe = Get-ChildItem -Filter "Ten10_*_x64_with_WebView2-setup.exe" | Select-Object -First 1 -ExpandProperty Name
          gh release upload "${{ github.ref_name }}" $exe --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Cleanup (Windows certificate)
      # - name: Cleanup certificate (Windows)
      #   if: matrix.platform == 'windows-latest' && always()
      #   run: |
      #     if (Test-Path cert.txt) { Remove-Item cert.txt }
      #     if (Test-Path certificate.pfx) { Remove-Item certificate.pfx }

  # Notify on completion (optional)
  notify:
    needs: release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check release status
        run: |
          if [ "${{ needs.release.result }}" == "success" ]; then
            echo "✅ Release completed successfully!"
          else
            echo "❌ Release failed!"
            exit 1
          fi
