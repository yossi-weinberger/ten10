# Supabase Integration Status

This document tracks the progress of integrating Supabase into the Ten10 project (primarily for the web version).

## Completed Tasks

### Authentication

- **Project Setup:**
  - Configured Supabase client (`@supabase/supabase-js`).
  - Set up environment variables for Supabase URL and Anon Key.
  - Fixed TypeScript config for Vite env variables.
- **Authentication State Management:**
  - Created `AuthContext` with `onAuthStateChange` listener.
  - Wrapped application with `AuthProvider`.
  - **AuthContext now handles clearing the `transactions` state (Zustand) on sign-out. Data loading logic has been enhanced to be conditional (see Optimized Data Fetching below).**
- **Platform-Specific UI:**
  - Created Login (`LoginPage.tsx`) and Signup (`SignupPage.tsx`) pages, displayed only on the web platform.
  - Utilized `PlatformContext` for conditional rendering.
  - Translated forms to Hebrew.
- **Login Methods Implemented:**
  - Email/Password (`signInWithPassword`).
  - Google Sign-In (`signInWithOAuth`) - UI added, requires manual setup in dashboards.
  - Magic Link (`signInWithOtp`) - UI added, enabled by default in Supabase.
- **User Profiles & RLS:**
  - Created `public.profiles` table (`id`, `updated_at`, `full_name`, `avatar_url`, `mailing_list_consent`).
  - Established Foreign Key to `auth.users`.
  - Enabled RLS on `profiles` table.
  - Added basic RLS policies (select/insert/update own profile).
  - Added trigger to create profile on new user signup.
  - Added trigger to update `updated_at` automatically.
- **Signup Enhancements:**
  - Added Full Name and Mailing List Consent fields to the signup form.
  - Updated signup logic to attempt profile update if session is immediately available.
- **Protected Routes (Web):**
  - Implemented route protection via `beforeLoad` on the root route in `src/routes.ts`.
  - Logic correctly differentiates between web (protected) and desktop (open). Redirects unauthenticated web users to `/login`.
- **Logout:**
  - Logout button in `Sidebar.tsx` triggers `signOut` and navigates user to `/login`.
  - Logout button styled in red.
- **Manual Setup:**
  - Completed Google Sign-In setup in Google Cloud Console and Supabase Dashboard (added Client ID/Secret).
  - Verified Supabase URL Configuration (`Site URL`, `Additional Redirect URLs`) for Magic Link and OAuth.
- **State Synchronization:**
  - Transaction data fetched via `dataService` is loaded into the Zustand store (`useDonationStore`), triggered by authentication events and data freshness checks managed in `AuthContext`.
  - **Optimized Data Fetching:** Implemented conditional data loading from the database to avoid fetching on every page refresh. Data is fetched upon user login (via a `forceDbFetchOnLoad` flag in `sessionStorage`), or if existing data in Zustand is stale (e.g., older than 1 day, based on `lastDbFetchTimestamp` in Zustand). `AuthContext` manages this, including Zustand store rehydration (`_hasHydrated`). `LoginPage.tsx` and `SignupPage.tsx` set the `forceDbFetchOnLoad` flag.

### Database (Transactions - Web Version)

- **Project Identified:** Confirmed Supabase project `Ten10` (ID: `flpzqbvbymoluoeeeofg`).
- **`transactions` Table Created:** Added the `public.transactions` table based on the defined schema.
  - **Note on Naming Convention:** Column names were initially `snake_case`, but later updated to `camelCase` (e.g., `"isChomesh"`, `"isRecurring"`, `"createdAt"`) to resolve frontend integration issues. `id` and `user_id` remain `snake_case`.
  - **Primary Key:** `id` column is of type `uuid` and generated by the database (`DEFAULT gen_random_uuid()`).
- **Row Level Security (RLS) Enabled:** RLS has been activated for the `transactions` table.
- **RLS Policies Applied:** Created and verified policies (`SELECT`, `INSERT`, `UPDATE`, `DELETE`) ensuring users can only access their own data (`USING (auth.uid() = user_id)`).
- **`updatedAt` Trigger:** Configured a trigger using the shared `handle_updated_at` function to automatically update the `"updatedAt"` column on changes.
- **`dataService.ts` Integration:** Updated `loadTransactions` and `addTransaction` functions to interact with the Supabase `transactions` table for the web platform.
  - Fetches user data using Anon Key (RLS enforced).
  - Lets the database generate the `id` (UUID).
  - Maps data between the mixed-case TypeScript `Transaction` type and the camelCase database columns during `insert`.
  - Fetches the newly created record after insert to update the Zustand store correctly.
  - **State Synchronization:** Transaction data fetched via `dataService` is loaded into the Zustand store (`useDonationStore`), triggered by authentication events managed in `AuthContext`.

## Known Issues & Workarounds

### Supabase Client Hangs After Refresh (Chrome/Vite/React)

- **Issue Description:** A significant issue was identified where the `@supabase/supabase-js` client becomes unresponsive to network requests (both `select` and `rpc` calls) after a page refresh when a session is restored from localStorage (`persistSession: true`). The `onAuthStateChange` event fires correctly, indicating a valid session and user, but subsequent attempts to use the client for network operations hang indefinitely without sending a request or throwing a network error. This issue primarily affects Chrome-based browsers in the Vite/React development environment.
- **Root Cause Analysis:** The problem appears to be a race condition or an internal state inconsistency within the Supabase client during the session recovery process from localStorage after a page refresh. Attempting network requests immediately within the `onAuthStateChange` callback triggers this hung state.
- **Related GitHub Issue:** This behavior is similar or identical to issues reported by other users: [https://github.com/supabase/supabase-js/issues/1401](https://github.com/supabase/supabase-js/issues/1401)
- **Workaround Implemented:** To resolve this, the data loading logic was decoupled from the `onAuthStateChange` listener in `AuthContext.tsx`:
  1.  `onAuthStateChange` now only updates the `session` and `user` state variables.
  2.  A separate `useEffect` hook was added, dependent on the `user` and `platform` state variables.
  3.  This `useEffect` initiates the data loading (`loadAndSetTransactions`) only when a valid `user` exists and the `platform` is determined.
  4.  This separation allows the Supabase client sufficient time to stabilize after session recovery before network requests are initiated, preventing the hang.
- **Impact:** This workaround successfully resolves the refresh issue and allows the application to function correctly. However, it highlights a potential instability in the current version of `@supabase/supabase-js` under these specific conditions.

## Remaining Tasks / Next Steps

### Authentication

- **Profile Management:**
  - Implement the actual Profile page (`/profile`) allowing users to view/update `full_name`, `avatar_url`, etc. (Partially done - display exists, update form needs completion).
  - Implement password update functionality on the Profile page.

### Database

- **Data Service Completeness:** Add `updateTransaction` and `deleteTransaction` functions to `dataService.ts` with platform-specific logic (Supabase for web).
- **Data Synchronization/Migration:** Define a strategy for potential data sync or migration between Desktop (SQLite) and Web (Supabase) if needed in the future.
- **Naming Convention Alignment (Recommended):** Consider aligning the `Transaction` TypeScript type and the Supabase database schema to use a consistent convention (ideally `snake_case` everywhere) to simplify `dataService` and improve maintainability. This would require updating the TS type and another DB migration.

### General

- **Testing:** Thoroughly test all CRUD operations and RLS rules on the web platform.
- **Error Handling:** Enhance error handling and user feedback for database operations.
